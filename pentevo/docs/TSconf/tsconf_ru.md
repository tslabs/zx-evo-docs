# TS-Configuration

## Содержание

* [Управление процессором]
	* [Изменение частоты работы процессора](#clock)
	* [Кэширование запросов к RAM]
* [Управление памятью]
	* [Управление портом $7FFD]
	* [Маппинг страниц в окне 0]
* [Контроллер прерываний]
* [Контроллер DMA]
* Графика

## Features

* High compatibility with original Pentagon clone

- Advanced video features:
  - Raster sizes: 360x288, 320x240, 320x200, 256x192 of standard pixel resolution
  - Up to 720x288 Hi-res pixel resolution
  - Hardware scrolled graphic planes
  - 256 and 16 indexed colors per pixel
  - Programmable palette up to 15625 colors using PWM video-DAC modulation
  - Handy 512 and 256 bytes per line addressing
  - Text mode with loadable font and hardware line-fine scroll
  - Up to 256 displayable video pages

- Hardware engine for Tiles and Sprites graphics
  - Up to 42 sprites per line (and non-limited sprites per frame using Sprite Reuse)
  - Sprites sized up to 64x64 pixels individually
  - Up to 3 prioritized sprite planes
  - Up to 2 prioritized tile planes with 8x8 pixels tiles
  - Tiles and sprites have ‘transparent’ color
  - Tiles and sprites have same graphics format allowing unified graphics processing
  - Individually programmable horizontal per-line pixel-fine scrolls for tiles planes
  - Individually programmable vertical per-column line-fine scrolls for tiles planes
  - Up to 16 palettes for sprites per line
  - Up to 4 palettes for tiles per line for each tile plane

- Z80 Memory addressing enhancements:
  - Programmable RAM page for any 16kB window individually
  - ‘Shadow’ RAM pages for #8000 and #C000 windows

- Z80 acceleration features
  - 14, 7 and 3,5MHz speed modes
  - 512 bytes of fast non-wait RAM for speed critical procedures for 14MHz speed
  - On-the-fly programmable INT position
  - Programmable IM2 vector

- Advanced hardware features
  - DRAM-to-Device, Device-to-DRAM and DRAM-to-DRAM DMA Controller
  
## Conventions

<to be added>

## Процессор и память

### Features
TS конфигурация позволяет изменять частоту работы процессора и управлять кэшированием запросов в RAM. Основным регистром управления является **SysConfig**. По сигналу RESET в него записывается значение $01 - кэширование отключено, частота работы процессора 7MHz.

### Страничная адресация памяти

TS конфигурация позволяет адресовать до 4096Кб RAM и 512Кб ROM. Процессору вся эта память проецируется в виде 64Кб, разделенных на 4 окна по 16Кб. Для управления содержимым каждого окна предусмотрен свой 8 битный регист.

Номер окна|Диапазон памяти|Регистр управления окном|R/W|Init
----------|---------------|------------------------|---|----
0         |#0000-#3FFF    |Page0                   | W |$00
1         |#4000-#7FFF    |Page1                   | W |$05
2         |#8000-#BFFF    |Page2                   |R/W|$02
3         |#C000-#FFFF    |Page3                   |R/W|$00

Память компьютера разбивается на страницы по 16Кб, таким образом становится доступно до 256 страниц RAM и 32 страниц ROM. Для выбора конкретной страницы в любом окне, необходимо лишь записать номер этой страницы в соответствующий регистр.

В окнах 1, 2, 3 отображаются только страницы RAM. В окне 0 можно отображать страницы RAM или ROM, в зависимости от бита *W0_RAM* регистра **MemConfig** (0 - отображается ROM, 1 - отображается RAM). При этом для выбора страницы ROM используются только биты 4:0 регистра **Page0**.

#### Регистр MemConfig
	Биты   7    6    5    4    3       2      1     0
	     LCK128[1:0] -    -  W0_RAM !W0_MAP W0_WE ROM128
	R/W    W    W              W       W      W     W
	Init   0    0    x    x    0       1      0     0

* Биты 7:6 - выбор режима ограничений порта $7FFD,
* Биты 5:4 - зарезервированы,
* Бит 3 - выбор ROM/RAM,
* Бит 2 - отключение маппинга,
* Бит 1 - разрешение записи в ROM/RAM,
* Бит 0 - выбор страниц маппинга.

С помощью бита *W0_WE* регистра **MemConfig** можно запретить (значение 0) или разрешить (значение 1) запись в окно 0. Для страниц RAM - это просто запрет записи данных. Для ROM запись будет производится на флеш память.

#### Управление портом $7FFD <a name="7ffd"></a>

Порт $7FFD работает аналогично стандартному Spectrum. Помимо этого можно настроить режим работы данного порта. Режим задается битами *LCK128*[1:0] регистра **MemConfig**:

LCK128[1:0]|Режим порта $7FFD| Подстановка бит в регистр Page3
-----------|-----------------|--------------------------------------
00         | 512Кб           | Page3[4:0] = $7FFD[7:6], $7FFD[2:0]
01         | 128Кб           | Page3[2:0] = $7FFD[2:0]
10         | Авто            | -
11         | 1024Кб          | Page3[5:0] = $7FFD[5], $7FFD[7:6], $7FFD[2:0]

При записи значений в порт $7FFD в режимах 128Кб, 512Кб и 1024Кб, биты, отвечающие за переключение страниц, записываются в младшие разряды регистра **Page3**.

Режим *Авто* позволяет с помощью длинной адресации порта работать с 512Кб RAM (`out (c),a`), а через короткую адресацию с 128Кб RAM (`out ($FD),a`). Режим адресации определяется по опкоду команды..

##### Порт $7FFD

	Биты   7    6    5    4      3    2  1  0
	     R512[7:6] LOCK ROM128 VPAGE R128[2:0]
	R/W    W    W    W    W      W    W  W  W
	Init   0    0    0    0      0    0  0  0
* Биты 7:6 - биты 4:3 регистра **Page3** для режима 512Кб,
* Бит 5 - бит 5 регистра **Page3** для режима 1024Кб или бит защелки порта,
* Бит 4 - аналог бита *ROM128* регистра **MemConfig**,
* Бит 3 - выбор видео страницы экрана Spectrum,
* Биты 2:0 - биты 2:0 регистра **Page3**.

При записи единицы в 5 бит (защелка) порта $7FFD в любом из режимов кроме 1024Кб происходит отключение порта $7FFD. После RESET порт снова доступен для записи.

#### Маппинг страниц в окне 0 <a name="mapping"></a>

В нулевом окне можно отображать страницы RAM/ROM в двух режимах:

* Режим маппинга страниц
* Обычный режим

Режим выбирается с помощью бита *!W0_MAP* регистра **MemConfig**: 0 - режим маппинга страниц, 1 - обычный режим. 

В обычном режиме номер проецируемой страницы берется из регистра **Page0**[7:0] для RAM и **Page0**[4:0] для ROM.

Режим маппинга страниц используется для подключения 64кб прошивок ПЗУ, которые могут располагаться как в ROM, так и в RAM компьютера. Выбор страницы этого ПЗУ происходит с помощью сигнала DOS и бита *ROM128* регистра **MemConfig** (или порта $7FFD). Сигнал DOS и бит *ROM128* подставляются в качестве 1 и 0 бита номера страницы соответственно, а все остальные биты берутся из регистра **Page0**, таким образом прошивки ПЗУ должны располагаться в страницах кратных 4.

Формат прошивок ПЗУ и управляющие сигналы для выбора страниц этого ПЗУ представлены в следующей таблице:

DOS|ROM128|Страницы ПЗУ
---|------|------------
0  | 0    |Service
0  | 1    |DOS
1  | 0    |128
1  | 1    |48

### Регистр SysConfig

Биты|7|6|5|4|3|2|1|0
----|-|-|-|-|-|-|-|-|
Name|-|-|-|-|-|CACHE|ZCLK[1]|ZCLK[0]
R/W|-|-|-|-|-|W|W|W
Сброс|x|x|x|x|x|0|0|0

* Биты 7:3 - зарезервированы.
* Бит 2 - разрешение кэширования запросов в RAM,
* Биты 1:0 - управление частотой процессора

#### Частота процессора <a name="clock"></a>

Всего поддерживается 3 режима работы процессора: 3.5MHz, 7.0MHz, 14.0MHz. Два младших бита регистра **SysConfig** позволяют выбрать один из этих режимов согласно следующей таблице:

ZCLK[1:0]| MHz
---------|----
00       |3.5
01       |7.0
10       |14.0
11       |зарезервировано

#### Кэш <a name="cache"></a>

В TS конфигурации можно включить кэширование всех запросов на чтение/запись между процессором и RAM. Запросы к ROM не кэшируются.

Отображаемая процессору память (64кб) условно делится на 4 окна по 16 килобайт и для каждого такого окна в регистре **CacheConfig** предусмотрен соответствующий бит, который включает или отключает кэшироване в этом окне.

### Регистр CacheConfig
	Биты 7  6  5  4    3       2       1       0
	     -  -  -  - EN_C000 EN_8000 EN_4000 EN_0000
	R/W                W       W       W       W
	Init x  x  x  x    0       0       0       0

* Биты 7:4 - зарезервированы.
* Бит 3 - разрешение кэширования окна RAM $C000-$FFFF,
* Бит 2 - разрешение кэширования окна RAM $8000-$BFFF,
* Бит 1 - разрешение кэширования окна RAM $4000-$7FFF,
* Бит 0 - разрешение кэширования окна RAM $0000-$3FFF,

При записи значения в бит *CACHE* регистра **SysConfig** это же значение копируется в биты 0-3 регистра **CacheConfig**. Это позволяет включать и отключать кэширование глобально для всех страниц RAM.

**Внимание!** Запросы от DMA к RAM не кэшируются. По этой причине после DMA транзакций, работающих с окнами RAM для которых включено кэширование, необходимо проводить инвалидацию кэша.

Инвалидация кэша представляет из себя цикл, в котором последовательно считываются любые 256 байт. Пример инвалидации кэша:

    LD HL,$FF00
    LD DE,$FF00
    LD BC,$0100
    LDIR

### FMAPS
    
## Контроллер прерываний

Для всех режимов прерываний (`IM 0`, `IM 1`, `IM 2`) TS конфигурация поддерживает несколько источников маскируемого прерывания INT:

* Кадровый (*FRAME*)
* Строчный (*LINE*)
* Окончание DMA транзакции (*DMA*) 

В случае прихода нескольких событий одновременно, сначала обрабатывается прерывание с меньшим приоритетом. При завершении ISR инструкциями `EI : RET` сразу произойдет обработка следующего по порядку прерывания, которое распознается в последнем машинном цикле инструкции `RET`.

#### Frame interrupt

Источник *FRAME* срабатывает, когда значение счетчиков растра совпадает с регистрами **HSINT**, **VSINT**. Источник *LINE* срабатывает в каждой строке, когда горизонтальный счетчик растра равен 0. Источник *DMA* срабатывает после окончания DMA транзакции.

#### Line interrupt
#### DMA interrupt
#### Wait Ports interrupt

В режиме `IM 2` каждый источник прерывания формирует сигнал INT и выставляет собственный адрес на шину данных.

Источник|Приоритет|Адрес
--------|---------|-----
FRAME   |    0    | $FF 
LINE    |    1    | $FD 
DMA     |    2    | $FB 

Регистр **INTMask** содержит биты индивидуального источника маскируемого прерывания: 0 - запрещен, 1 - разрешен. По RESET туда записывается значение $01 - разрешен *FRAME*, все остальные запрешены. Если из ISR с меньшим приоритетом записать 0 в соответствующий бит маски источника прерывания, ожидающего в данный момент обработки, то произойдет его сброс и прерывание обработано не будет. Запись 1 не влияет на состояние ожидающего прерывания.

### Registers

#### Регистр INTMask

	Биты  7   6   5   4   3   2    1    0
	      -   -   -   -   -  DMA LINE FRAME
	R/W                       W    W    W
	Init  x   x   x   x   x   0    0    1

* Биты 7:3 - зарезервированы,
* Бит 2 - разрешение источника *DMA*,
* Бит 1 - разрешение источника *LINE*,
* Бит 0 - разрешение источника *FRAME*,

## Графика

### Modes

#### ZX
#### 16c
#### 256c
#### text

### raster sizes
### screen page
### CRAM
#### VDAC mode
#### PWM mode
#### DMA
### scrolls
### registers

## TSU
### Features
### tiles
Overview

#### bitmap
#### tile map
#### scrolls
#### registers

### sprites
Overview

#### SFILE
#### registers

## Контроллер DMA

Контроллер DMA позволяет передавать данные между такими устройствами компьютера как RAM, IDE, SPI, CRAM и SFILE минуя процессор. Во время передачи данных процессор может быть занят чем-то другим. В один момент времени может быть запущена лишь одна DMA транзакция.

Для управления DMA предусмотрены следующие регистры:

Регистр  |Назначение
---------|-----------------------------
DMASAddr*| Адрес источника данных в RAM
DMADAddr*| Адрес приемника данных в RAM
DMALen   | Длина блока
DMANum   | Количество блоков
DMACtrl  | Регистр управления DMA
DMAStatus| Состояние контроллера DMA

DMA транзакция производит передачу данных блоками. Единицей данных в блоках является машинный WORD, т.е. 16 бит. В регистрах DMA контроллера можно установить как размер самого блока (регистр **DMALen**), так и количество блоков (регистр **DMANum**) для обработки. Дополнительно в регистре **DMACtrl** можно задать выравнивание для каждого блока транзакции.

Значения в регистрах **DMALen** и **DMANum** должны быть на единицу меньше, т.к. они находятся в диапазоне 1 - 256.

### Регистр DMACtrl

	Биты  7   6   5      4     3    2  1  0
	     W/R  - S_ALGN D_ALGN A_SZ DDEV[2:0]
	R/W   W       W      W     W    W  W  W
	Init  x   x   x      x     x    x  x  x

* Бит 7 - направление передачи данных: 0 - в память, 1 - из памяти,
* Бит 6 - зарезервировано,
* Бит 5 - включение выравнивания адреса источника (0 - отключено, 1 - включено),
* Бит 4 - включение выравнивания адреса приемника (0 - отключено, 1 - включено),
* Бит 3 - размер выравнивания: 0 - 256 байт, 1 - 512 байт,
* Биты 2:0 - выбор устройства для обмена данными.

Если включено выравнивания адреса источника или приемника, то после обработки каждого блока к предыдущему значению этого регистра прибавляется 256 или 512 байт в зависимости от бита *A_SZ*. Если выравнивание для адреса отключено, то значение регистра не изменяется и соответствует тому, что было в нем на момент окончания обработки последнего блока.

Адреса источника и приемника данных (*DMASAddr* и *DMADAddr*) являются 22 битными и для записи в них значений используются по 3 регистра: **DMASAddrL**, **DMASAddrH** и **DMASAddrX** - для адреса источника данных, **DMADAddrL**, **DMADAddrH**, **DMADAddrX** - для адреса приемника данных.

Для удобства адресации регистры **DMASAddrL** и **DMASAddrH** задают смещение внутри страницы памяти, а регистр **DMASAddrX** задает номер страницы. Для адреса приемника все аналогично.

Таблица выбора устройств:

Бит W/R|DDEV[2:0]|Источник|Приемник|Описание
:-----:|:-------:|:------:|:------:|----------------
   0   |   000   |   -    |   -    | Зарезервировано
   1   |   000   |   -    |   -    | Зарезервировано
   0   |   001   |  RAM   |  RAM   | Копирование RAM
   1   |   001   |  BLT   |  RAM   | Блиттинг RAM
   0   |   010   |  SPI   |  RAM   | Копирование из SPI в RAM
   1   |   010   |  RAM   |  SPI   | Копирование из RAM в SPI
   0   |   011   |  IDE   |  RAM   | Копирование из IDE в RAM
   1   |   011   |  RAM   |  IDE   | Копирование из RAM в IDE
   0   |   100   |  FILL  |  RAM   | Заполнение RAM
   1   |   100   |  RAM   |  CRAM  | Копирование из RAM в CRAM
   0   |   101   |   -    |   -    | Зарезервировано
   1   |   101   |  RAM   |  SFILE | Копирование из RAM в SFILE
   0   |   110   |   -    |   -    | Зарезервировано
   1   |   110   |   -    |   -    | Зарезервировано
   0   |   111   |   -    |   -    | Зарезервировано
   1   |   111   |   -    |   -    | Зарезервировано

**Блиттинг RAM**

Данные читаются из источника и приемника. Если значение в приемника не равно 0, то данные из источника записываются туда.

**Заполнение RAM**

Читается один WORD из источника и это значение используется для заполнения приемника.

### Регистр DMAStatus

	Биты    7    6  5  4  3  2  1  0
	     DMA_ACT -  -  -  -  -  -  -
	R/W     R
	Init    x    x  x  x  x  x  x  x

* Бит 7 - состояние DMA транзакции (0 - не активна, 1 - активна),
* Биты 6:0 - зарезервированы.

Состояние DMA транзакции можно определить по биту *DMA_ACT* регистра **DMAStatus**. По окончанию транзакции генерируется соответствующее прерывание, если оно было разрешено. Подробнее об этом можно узнать в разделе [Контроллер прерываний][interrupts].

**Внимание!** Данные, передаваемые с помощью DMA не кэшируются, поэтому работать с ними необходимо через окна памяти для которых отключено кэширование, либо после транзакций производить инвалидацию кэша. Подробнее о работе кэша описано в разделе [Кэширование запросов к RAM][cpu#cache].

## Sound

### Registers

## SPI

### Registers

## IDE

### Registers

## RTC

### Registers

## VDOS

### Registers

## Credits
Special thanks to: Earl (Dmitry Limonov) for initial version of this datasheet in Russian.
